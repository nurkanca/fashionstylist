<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Fashion Stylist - Premium Frontend</title>

  <style>
    :root{
      /* ‚úÖ Light + Fashion */
      --bg1:#f6f7fb;
      --bg2:#eef2ff;
      --card:#ffffff;
      --card2:#fbfbff;

      --text:#0f172a;
      --muted:#64748b;
      --line:rgba(15,23,42,.10);

      --ok:#16a34a;
      --err:#ef4444;
      --warn:#f59e0b;

      --gradA:#6d28d9;
      --gradB:#db2777;
      --gradC:#0ea5e9;

      --btnText:#fff;
      --shadow: 0 20px 60px rgba(15,23,42,.08);
      --shadow2: 0 30px 110px rgba(0,0,0,.18);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 0%, rgba(109,40,217,.16) 0%, transparent 55%),
        radial-gradient(900px 650px at 85% 10%, rgba(219,39,119,.12) 0%, transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }

    /* ====== Header ====== */
    header{
      position: sticky;
      top:0;
      z-index:50;
      backdrop-filter: blur(10px);
      background: rgba(255,255,255,.72);
      border-bottom: 1px solid var(--line);
    }
    .wrap{ max-width:1160px; margin:0 auto; padding:16px; }

    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .brandLeft{
      display:flex; gap:12px; align-items:center;
    }
    .logo{
      width:38px; height:38px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(109,40,217,.95), rgba(219,39,119,.9));
      box-shadow: 0 18px 38px rgba(109,40,217,.18);
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-weight:900;
    }
    .brand h1{ margin:0; font-size:16px; letter-spacing:.2px; }
    .brand p{ margin:4px 0 0; color:var(--muted); font-size:12px; }

    .topRight{
      display:flex; align-items:center; gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.7);
      font-size:12px;
      color:var(--muted);
      box-shadow: 0 8px 26px rgba(15,23,42,.06);
    }
    .pill b{ color:var(--text); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }

    /* ====== Layout ====== */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      padding:16px;
      max-width:1160px;
      margin:0 auto;
    }
    @media(min-width:980px){
      .grid{ grid-template-columns: 360px 1fr; }
    }

    /* ====== Cards ====== */
    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      position:relative;
      overflow:hidden;
      transform: translateY(0);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .card:hover{
      transform: translateY(-2px);
      box-shadow: 0 25px 70px rgba(15,23,42,.10);
    }
    .card h2{
      margin:0 0 10px;
      font-size:14px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .muted{ color:var(--muted); }

    .hr{
      height:1px;
      background: var(--line);
      margin:14px 0;
    }

    /* ====== Inputs ====== */
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:10px 0 6px;
    }
    input, select, textarea{
      width:100%;
      background: rgba(255,255,255,.95);
      border:1px solid rgba(15,23,42,.12);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      outline:none;
      transition: border .2s ease, box-shadow .2s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(109,40,217,.35);
      box-shadow: 0 0 0 4px rgba(109,40,217,.10);
    }
    textarea{ min-height:80px; resize:vertical; }

    /* ====== Buttons ====== */
    .row{
      display:flex; gap:10px; align-items:center;
      flex-wrap:wrap;
    }
    .row > *{ flex:1; }

    button{
      border:0;
      border-radius: 14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800;
      transition: transform .12s ease, box-shadow .2s ease, opacity .2s ease;
      user-select:none;
    }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .btnPrimary{
      color:var(--btnText);
      background: linear-gradient(90deg, var(--gradA), var(--gradB));
      box-shadow: 0 16px 40px rgba(109,40,217,.18);
    }
    .btnPrimary:hover{
      box-shadow: 0 18px 45px rgba(219,39,119,.18);
      transform: translateY(-1px);
    }

    .btnSecondary{
      color:#0f172a;
      background: rgba(15,23,42,.05);
      border:1px solid rgba(15,23,42,.10);
    }
    .btnSecondary:hover{
      background: rgba(15,23,42,.07);
    }

    .btnGhost{
      background: transparent;
      border:1px solid rgba(15,23,42,.12);
      color: var(--text);
    }
    .btnGhost:hover{
      background: rgba(15,23,42,.04);
    }

    .btnSmall{
      padding:8px 10px;
      border-radius: 999px;
      font-size:12px;
      font-weight:800;
    }

    /* ====== Tabs ====== */
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top: 6px;
    }
    .tab{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.7);
      color: var(--text);
      font-size:12px;
      cursor:pointer;
      user-select:none;
      transition: all .2s ease;
    }
    .tab.active{
      background: linear-gradient(90deg, rgba(109,40,217,.14), rgba(219,39,119,.12));
      border-color: rgba(109,40,217,.28);
      transform: translateY(-1px);
    }

    .section{
      display:none;
      margin-top:12px;
      opacity:0;
      transform: translateY(6px);
      transition: opacity .25s ease, transform .25s ease;
    }
    .section.active{
      display:block;
      opacity:1;
      transform: translateY(0);
    }

    /* ====== Status ====== */
    .status{
      margin-top:10px;
      padding:10px 10px;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.75);
      font-size:12px;
      white-space:pre-wrap;
      color:var(--muted);
      overflow:auto;
      max-height:160px;
    }
    .status.ok{ border-color: rgba(22,163,74,.28); color:#14532d; background: rgba(22,163,74,.06); }
    .status.err{ border-color: rgba(239,68,68,.28); color:#7f1d1d; background: rgba(239,68,68,.06); }
    .status.warn{ border-color: rgba(245,158,11,.28); color:#7c2d12; background: rgba(245,158,11,.06); }

    /* ====== Image Grid ====== */
    .imgGrid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
      gap:12px;
    }
    .imgCard{
      border:1px solid rgba(15,23,42,.10);
      border-radius: 18px;
      overflow:hidden;
      background: rgba(255,255,255,.75);
      box-shadow: 0 14px 40px rgba(15,23,42,.06);
      transition: transform .18s ease, box-shadow .2s ease;
    }
    .imgCard:hover{
      transform: translateY(-2px);
      box-shadow: 0 18px 55px rgba(15,23,42,.10);
    }
    .imgCard img{
      width:100%;
      height:160px;
      object-fit:cover;
      display:block;
      background:#f2f4ff;
      cursor: zoom-in;
      transition: transform .25s ease;
    }
    .imgCard:hover img{ transform: scale(1.03); }
    .imgMeta{ padding:10px; }
    .imgMeta .title{ font-size:12px; font-weight:900; }
    .imgMeta .sub{ font-size:11px; color:var(--muted); margin-top:4px; }

    .chips{
      display:flex; gap:6px; flex-wrap:wrap; margin-top:8px;
    }
    .chip{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(109,40,217,.06);
      color: var(--text);
      opacity:.92;
    }

    /* ====== Lists ====== */
    .list{
      display:flex; flex-direction:column; gap:10px;
    }
    .listItem{
      border:1px solid rgba(15,23,42,.10);
      border-radius: 18px;
      padding:12px;
      background: rgba(255,255,255,.70);
      box-shadow: 0 14px 40px rgba(15,23,42,.05);
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      transition: transform .18s ease;
    }
    .listItem:hover{ transform: translateY(-1px); }
    .listItem .left{ min-width:220px; flex:1; }
    .listItem .right{ display:flex; gap:8px; flex-wrap:wrap; }

    /* ====== Custom File Input ====== */
    .fileWrap{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .fileInputHidden{
      display:none;
    }
    .fileBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px dashed rgba(109,40,217,.35);
      background: linear-gradient(90deg, rgba(109,40,217,.08), rgba(219,39,119,.06));
      cursor:pointer;
      font-weight:900;
      min-width:140px;
    }
    .fileName{
      flex:1;
      min-width:180px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.85);
      color: var(--muted);
      font-size:12px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* ====== FILTER BUTTONS ====== */
    .filterBar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }
    .filterBtn{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.70);
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      transition: .2s ease;
    }
    .filterBtn.active{
      background: linear-gradient(90deg, rgba(14,165,233,.14), rgba(109,40,217,.12));
      border-color: rgba(14,165,233,.25);
      transform: translateY(-1px);
    }

    /* =========================
       ‚úÖ IMAGE MODAL (LIGHTBOX)
       ========================= */
    #imgModal{
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.62);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 18px;
      animation: fadeIn .18s ease both;
    }
    #imgModal.open{ display:flex; }
    #imgModal .box{
      position: relative;
      max-width: min(1100px, 95vw);
      max-height: 90vh;
      border-radius: 20px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: var(--shadow2);
      background: rgba(255,255,255,.98);
      animation: popIn .18s ease both;
    }
    #imgModal img{
      display:block;
      max-width: 95vw;
      max-height: 82vh;
      object-fit: contain;
      background: #f4f6ff;
      cursor: default;
    }
    #imgModal .caption{
      padding: 10px 12px;
      font-size: 12px;
      color: var(--muted);
      border-top: 1px solid rgba(15,23,42,.08);
    }
    #imgModal .closeBtn{
      position:absolute;
      top:10px;
      right:10px;
      width:44px; height:44px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(15,23,42,.06);
      cursor:pointer;
      font-weight:900;
      font-size:18px;
    }
    #imgModal .closeBtn:hover{
      background: rgba(15,23,42,.10);
    }

    /* =========================
       ‚úÖ AUTH MODAL (PORTRAIT)
       ========================= */
       /* ‚úÖ AUTH MODAL */
   #authModal{
     position: fixed;
     inset: 0;
     background: rgba(10,14,26,.55);
     backdrop-filter: blur(10px);
     display: none;
     align-items: center;
     justify-content: center;
     z-index: 9999;
     padding: 18px;
   }

   #authModal.open{ display:flex; }

   #authModal .authBox{
     width: min(420px, 92vw);        /* ‚úÖ √ßok geni≈ü olmasƒ±n */
     border-radius: 22px;
     background: rgba(255,255,255,.94);
     box-shadow: 0 22px 70px rgba(0,0,0,.25);
     overflow: hidden;

     /* ‚úÖ BO≈ûLUƒûU ENGELLE */
     height: auto;                  /* ‚úÖ i√ßerik kadar */
     max-height: 92vh;              /* ‚úÖ ekrana ta≈ümasƒ±n */
     display: flex;
     flex-direction: column;
   }
   #authModal .authHeader{
     padding: 18px 18px 14px;
     background: linear-gradient(135deg, rgba(236,72,153,.18), rgba(99,102,241,.12));
     border-bottom: 1px solid rgba(0,0,0,.06);
   }

   #authModal .authBody{
     padding: 16px 18px 18px;
     display: flex;
     flex-direction: column;
     gap: 12px;
   }

   #authModal .authFooter{
     padding: 14px 18px;
     border-top: 1px solid rgba(0,0,0,.06);
     background: rgba(245,246,255,.6);
     font-size: 12px;
     color: #6b7280;
   }


    .authTop{
      padding:16px 16px 10px;
      border-bottom: 1px solid rgba(15,23,42,.08);
      background:
        radial-gradient(500px 260px at 10% 10%, rgba(109,40,217,.12), transparent 50%),
        radial-gradient(500px 260px at 90% 0%, rgba(219,39,119,.10), transparent 55%),
        rgba(255,255,255,.96);
    }

    .authTitle{
      font-size:22px;
      font-weight:1000;
      letter-spacing:.2px;
      margin:0;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .authSub{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
    }

    .authClose{
      position:absolute;
      top:14px;
      right:14px;
      width:44px; height:44px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(15,23,42,.06);
      font-weight:900;
      font-size:18px;
      cursor:pointer;
    }

    .authBody{
      padding:14px 16px 16px;
      overflow:auto;
      flex:1;
    }

    .authTabs{
      display:flex;
      gap:10px;
      margin-top:12px;
    }
    .authTabs .tabBtn{
      flex:1;
      text-align:center;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      font-weight:900;
      cursor:pointer;
      transition:.2s ease;
    }
    .authTabs .tabBtn.active{
      background: linear-gradient(90deg, rgba(109,40,217,.18), rgba(219,39,119,.14));
      border-color: rgba(109,40,217,.25);
      transform: translateY(-1px);
    }

    .authPrimaryBtn{
      width:100%;
      padding: 12px 14px !important;
      border-radius: 16px !important;
      font-size: 16px;
      font-weight: 1000;
      color:#fff;
      background: linear-gradient(90deg, var(--gradA), var(--gradB)) !important;
      box-shadow: 0 16px 40px rgba(109,40,217,.18);
      margin-top:10px;
    }
    .authPrimaryBtn:hover{
      transform: translateY(-1px);
      box-shadow: 0 18px 45px rgba(219,39,119,.18);
    }

    /* =========================
       ‚úÖ OUTFIT MODAL (NICE)
       ========================= */
    #outfitModal{
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.62);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 9998;
      padding: 18px;
      animation: fadeIn .18s ease both;
    }
    #outfitModal.open{ display:flex; }

    #outfitModal .outfitBox{
      width: min(720px, 94vw);
      height: min(86vh, 720px);
      overflow: hidden;
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: var(--shadow2);
      background: rgba(255,255,255,.98);
      display:flex;
      flex-direction:column;
      animation: popIn .20s ease both;
    }

    .outfitHeader{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(15,23,42,.08);
      background:
        radial-gradient(550px 260px at 10% 0%, rgba(14,165,233,.12), transparent 55%),
        radial-gradient(550px 260px at 90% 10%, rgba(219,39,119,.10), transparent 55%),
        rgba(255,255,255,.95);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }

    .outfitTitle{
      font-size: 16px;
      font-weight: 1000;
      letter-spacing: .2px;
      margin:0;
    }
    .outfitMeta{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    .outfitClose{
      width:44px;
      height:44px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(15,23,42,.06);
      cursor:pointer;
      font-weight:900;
      font-size:18px;
    }

    .outfitBody{
      padding: 14px 16px;
      overflow:auto;
      flex:1;
    }

    .outfitSectionTitle{
      margin: 10px 0 8px;
      font-weight: 1000;
      font-size: 13px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .outfitSectionTitle .tag{
      padding: 4px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:900;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(109,40,217,.06);
    }

    .outfitFooter{
      padding: 12px 16px;
      border-top: 1px solid rgba(15,23,42,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      background: rgba(255,255,255,.95);
    }

    /* ====== Stars ====== */
    .stars{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .star{
      width:34px;
      height:34px;
      border-radius: 12px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.04);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:.15s ease;
      font-size:16px;
      user-select:none;
    }
    .star:hover{ transform: translateY(-1px); }
    .star.active{
      background: linear-gradient(90deg, rgba(245,158,11,.22), rgba(219,39,119,.10));
      border-color: rgba(245,158,11,.32);
    }
    .starLabel{
      font-size:12px;
      color:var(--muted);
      margin-left:6px;
      font-weight:900;
    }

    /* ====== Animations ====== */
    @keyframes fadeIn{
      from{ opacity:0; }
      to{ opacity:1; }
    }
    @keyframes popIn{
      from{ transform: translateY(10px) scale(.98); opacity:.75; }
      to{ transform: translateY(0) scale(1); opacity:1; }
    }

    .starsRow{
  display:flex;
  gap:6px;
}
.starBtn{
  border:1px solid rgba(0,0,0,.15);
  background: rgba(255,255,255,.55);
  border-radius: 12px;
  padding: 8px 10px;
  cursor:pointer;
  font-size:18px;
  line-height: 1;
  transition: transform .12s ease, box-shadow .12s ease;
}
.starBtn:hover{
  transform: scale(1.08);
  box-shadow: 0 8px 20px rgba(0,0,0,.12);
}


  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="brand">
      <div class="brandLeft">
        <div class="logo">FS</div>
        <div>
          <h1>Fashion Stylist ‚Äî Premium Demo UI</h1>
          <p>Spring Boot API + Clothes + Outfits + Recommend + Render + Survey</p>
        </div>
      </div>
      <div class="topRight">
        <div class="pill"><b>Base:</b> <span id="baseLabel" class="mono">http://localhost:8080</span></div>
        <div class="pill"><b>JWT:</b> <span id="tokenLabel" class="mono">(none)</span></div>
        <button class="btnSecondary btnSmall" onclick="openAuthModal()">Login</button>
        <button class="btnGhost btnSmall" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>
</header>

<div class="grid">
  <!-- LEFT CARD -->
  <div class="card">
    <h2>
      Controls
      <span class="muted" style="font-size:12px">Quick actions + Survey</span>
    </h2>

    <label>Backend Base URL</label>
    <input id="baseUrl" value="http://localhost:8080" oninput="syncBaseLabel()" />

    <div class="hr"></div>

    <h2 style="margin-top:0">Upload Clothe</h2>

    <label>Choose file</label>
    <div class="fileWrap">
      <input id="clotheFile" class="fileInputHidden" type="file" accept="image/*" onchange="showSelectedFileName()" />
      <label for="clotheFile" class="fileBtn">üì∑ Choose</label>
      <div id="selectedFileName" class="fileName">No file selected</div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btnPrimary" onclick="addClothe()">Upload</button>
      <button class="btnSecondary" onclick="loadMyClothes()">Reload</button>
    </div>

    <div id="uploadStatus" class="status">Upload status will appear here.</div>

    <div class="hr"></div>

    <h2 style="margin-top:0">Quick Actions</h2>
    <div class="row">
      <button class="btnSecondary" onclick="loadOutfits()">Load Outfits</button>
      <button class="btnSecondary" onclick="loadPreferences()">Load Preferences</button>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btnSecondary" onclick="appendWeatherToChat()">Add Weather to Prompt</button>
      <button class="btnGhost" onclick="clearAll()">Clear UI</button>
    </div>

    <div id="prefStatus" class="status">Preferences not loaded yet.</div>

    <div class="hr"></div>

    <h2 style="margin-top:0">Survey (Preferences)</h2>
    <div class="muted" style="font-size:12px; margin-bottom:8px">
      Only allowed colors/styles are shown (frontend whitelist).
    </div>

    <label>Favorite Colors</label>
    <div id="colorsBox" class="chips"></div>

    <label>Favorite Styles</label>
    <div id="stylesBox" class="chips"></div>

    <label>Outfit Preference</label>
    <select id="outfitPreferenceSelect">
      <option value="ONE_PIECE">ONE_PIECE</option>
      <option value="TOP_BOTTOM">TOP_BOTTOM</option>
      <option value="EQUAL">EQUAL</option>
    </select>

    <div class="row" style="margin-top:10px">
      <button class="btnPrimary" onclick="saveSurvey()">Save Survey</button>
      <button class="btnSecondary" onclick="resetSurvey()">Reset</button>
    </div>

    <div id="surveyStatus" class="status">Survey status will appear here.</div>
  </div>

  <!-- RIGHT CARD -->
  <div class="card">
    <h2>Dashboard</h2>

    <div class="tabs">
      <div class="tab active" data-tab="clothesSec">My Clothes</div>
      <div class="tab" data-tab="outfitsSec">Outfits</div>
      <div class="tab" data-tab="recommendSec">Recommendations</div>
      <div class="tab" data-tab="renderSec">Render on Model</div>
    </div>

    <!-- Clothes -->
    <div id="clothesSec" class="section active">
      <div class="row">
        <div class="pill"><b>Clothes:</b> <span id="clotheCount">0</span></div>
        <button class="btnGhost btnSmall" onclick="loadMyClothes()">Reload</button>
      </div>

      <div class="filterBar">
        <div class="filterBtn active" data-filter="all" onclick="setClothesFilter('all')">All</div>
        <div class="filterBtn" data-filter="top" onclick="setClothesFilter('top')">Top</div>
        <div class="filterBtn" data-filter="bottom" onclick="setClothesFilter('bottom')">Bottom</div>
        <div class="filterBtn" data-filter="shoes" onclick="setClothesFilter('shoes')">Shoes</div>
      </div>

      <div id="clothesStatus" class="status">No data yet.</div>
      <div style="margin-top:12px" class="imgGrid" id="clothesGrid"></div>
    </div>

    <!-- Outfits -->
    <div id="outfitsSec" class="section">
      <div class="row">
        <div class="pill"><b>Outfits:</b> <span id="outfitCount">0</span></div>
        <button class="btnGhost btnSmall" onclick="loadOutfits()">Reload</button>
      </div>

      <div id="outfitsStatus" class="status">No data yet.</div>

      <div class="hr"></div>

      <div class="row">
        <div>
          <label>Outfit ID (detail)</label>
          <input id="outfitIdInput" placeholder="e.g. 12"/>
        </div>
        <div style="display:flex; align-items:end; gap:10px">
          <button class="btnSecondary" onclick="showOutfitPopup(document.getElementById('outfitIdInput').value)">Show Detail</button>
          <button class="btnPrimary" onclick="renderOutfitOnModel()">Render</button>
        </div>
      </div>

      <div class="hr"></div>
      <div class="list" id="outfitList"></div>
    </div>

    <!-- Recommend -->
    <div id="recommendSec" class="section">
      <label>Chat prompt</label>
      <textarea id="chatInput" placeholder="e.g. I want a casual outfit for a coffee date"></textarea>

      <div class="row" style="margin-top:10px">
        <button class="btnSecondary" onclick="appendWeatherToChat()">Add Weather to Prompt</button>
        <button class="btnPrimary" onclick="recommendByChat()">Recommend</button>
      </div>

      <div id="recommendStatus" class="status">No recommendation yet.</div>

      <div class="hr"></div>
      <div class="list" id="recommendList"></div>
    </div>

    <!-- Render -->
    <div id="renderSec" class="section">
      <div class="row">
        <div>
          <label>Outfit ID to Render</label>
          <input id="renderOutfitId" placeholder="e.g. 12"/>
        </div>
        <div style="display:flex; align-items:end">
          <button class="btnPrimary" onclick="renderOutfitOnModel(true)">Render Outfit</button>
        </div>
      </div>

      <div id="renderStatus" class="status">No render yet.</div>
      <div style="margin-top:12px" class="imgGrid" id="renderGrid"></div>
    </div>

  </div>
</div>

<!-- ‚úÖ IMAGE MODAL -->
<div id="imgModal" onclick="closeImageModal(event)">
  <div class="box" onclick="event.stopPropagation()">
    <button class="closeBtn" onclick="closeImageModal(event)">‚úï</button>
    <img id="imgModalImg" src="" alt="preview"/>
    <div id="imgModalCaption" class="caption"></div>
  </div>
</div>

<!-- ‚úÖ AUTH MODAL -->
<div id="authModal" onclick="closeAuthModal(event)">
  <div class="authBox" onclick="event.stopPropagation()">
    <button class="authClose" onclick="closeAuthModal(event)">‚úï</button>

    <div class="authTop">
      <h3 class="authTitle">Welcome ‚ú®</h3>
      <div class="authSub">Please login or register to continue.</div>

      <div class="authTabs">
        <button id="authTabLogin" class="tabBtn active" onclick="switchAuthTab('login')">Login</button>
        <button id="authTabRegister" class="tabBtn" onclick="switchAuthTab('register')">Register</button>
      </div>
    </div>

    <div class="authBody">
      <!-- LOGIN -->
      <div id="authLoginSec">
        <label>Username</label>
        <input id="loginUser" placeholder="username"/>
        <label>Password</label>
        <input id="loginPass" type="password" placeholder="password"/>
        <button class="authPrimaryBtn" onclick="login()">Login</button>
        <div id="authStatus" class="status" style="margin-top:10px">Ready.</div>
      </div>

      <!-- REGISTER -->
      <div id="authRegisterSec" style="display:none">
        <label>Username</label>
        <input id="regUser" placeholder="username"/>
        <label>Password</label>
        <input id="regPass" type="password" placeholder="password"/>
        <label>Name</label>
        <input id="regName" placeholder="Full name"/>
        <label>Gender</label>
        <select id="regGender">
          <option value="male">male</option>
          <option value="female">female</option>
        </select>
        <button class="authPrimaryBtn" onclick="register()">Register</button>
        <div id="authStatus2" class="status" style="margin-top:10px">Ready.</div>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ OUTFIT DETAIL MODAL -->
<div id="outfitModal" onclick="closeOutfitModal(event)">
  <div class="outfitBox" onclick="event.stopPropagation()">
    <div class="outfitHeader">
      <div>
        <div id="outfitModalTitle" class="outfitTitle">Outfit Detail</div>
        <div id="outfitModalMeta" class="outfitMeta">
          <div style="margin-top:10px; display:flex; align-items:center; gap:10px;">
    <div style="font-weight:700;">Rate this outfit:</div>

    <div class="starsRow">
      <button class="starBtn" onclick="rateOutfit(lastOpenedOutfitId, 1)">‚òÖ</button>
      <button class="starBtn" onclick="rateOutfit(lastOpenedOutfitId, 2)">‚òÖ</button>
      <button class="starBtn" onclick="rateOutfit(lastOpenedOutfitId, 3)">‚òÖ</button>
      <button class="starBtn" onclick="rateOutfit(lastOpenedOutfitId, 4)">‚òÖ</button>
      <button class="starBtn" onclick="rateOutfit(lastOpenedOutfitId, 5)">‚òÖ</button>
    </div>
  </div>
</div>
      </div>
      <button class="outfitClose" onclick="closeOutfitModal(event)">‚úï</button>
    </div>

    <div class="outfitBody">
      <div id="outfitModalStatus" class="status" style="margin:0 0 12px;">Loading...</div>

      <div class="outfitSectionTitle"><span class="tag">TOP / ONE-PIECE</span></div>
      <div id="outfitTopGrid" class="imgGrid"></div>

      <div class="outfitSectionTitle" style="margin-top:14px"><span class="tag">BOTTOM</span></div>
      <div id="outfitBottomGrid" class="imgGrid"></div>

      <div class="outfitSectionTitle" style="margin-top:14px"><span class="tag">SHOES</span></div>
      <div id="outfitShoesGrid" class="imgGrid"></div>
    </div>

    <div class="outfitFooter">
      <div style="display:flex; flex-direction:column; gap:6px">
        <div class="stars" id="starBox">
          <!-- stars injected -->
        </div>
        <div class="muted" style="font-size:11px">
          Click stars to rate (updates personalScore on backend).
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <button class="btnSecondary" onclick="renderFromModal()">Render</button>
        <button class="btnGhost" onclick="closeOutfitModal(event)">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  // =========================
  // ‚úÖ Allowed Colors / Styles (Whitelist)
  // =========================
  const ALLOWED_COLORS = [
    "red","blue","yellow","green","orange","purple","black","white","gray","brown",
    "beige","cream","burgundy","pink","navy blue","indigo","khaki","gold","silver","bronze","patterned","striped"
  ];

  const ALLOWED_STYLES = [
    "t-shirt","shirt","blouse","sweater","cardigan","sweatshirt","hoodie","polo shirt","tank top","bodysuit","bustier","tunic",
    "pants","jeans","dress pants","cargo pants","skirt","mini skirt","midi skirt","maxi skirt","shorts","capri pants","leggings","sweatpants","wide-leg skirt pants",
    "jacket","blazer","denim jacket","leather jacket","bomber jacket","coat","trench coat","raincoat","parka","vest",
    "dress","jumpsuit","overalls",
    "sneakers","boots","sandals","heels","flats","loafers",
    "hat","scarf","gloves","belt","tie","handbag"
  ];

  const OUTFIT_RATE_ENDPOINT_TEMPLATE = (id) => `/api/outfit/${id}/rate`; // ‚úÖ change if needed


  // =========================
  // ‚úÖ UI State
  // =========================
  let clothesCache = [];
  let currentClothesFilter = "all";
  const clotheImageMap = new Map(); // id -> dataUrl

  let lastOpenedOutfitId = null;
  let lastRenderObjectUrl = null;

  // =========================
  // TAB SYSTEM (Smooth + triggers)
  // =========================
  document.querySelectorAll(".tab").forEach(t => {
    t.addEventListener("click", () => {
      const tabId = t.dataset.tab;

      // Tabs UI
      const parent = t.parentElement;
      parent.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
      t.classList.add("active");

      // Sections
      const mainCard = document.querySelectorAll(".card")[1];
      mainCard.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      mainCard.querySelector("#" + tabId).classList.add("active");

      // ‚úÖ Clothes filter reset when leaving clothesSec
      if (tabId !== "clothesSec") {
        setClothesFilter("all", true);
      }

      // ‚úÖ Outfit sec opened -> auto reload
      if (tabId === "outfitsSec" && getToken()) {
        loadOutfits();
      }
    });
  });

  function syncBaseLabel(){
    document.getElementById("baseLabel").textContent = getBaseUrl();
  }

  // =========================
  // Base URL / Token
  // =========================
  function getBaseUrl(){
    return (document.getElementById("baseUrl").value || "").trim().replace(/\/+$/, "");
  }

  function resolveUrl(u){
    if(!u) return "";
    const s = String(u);
    if (s.startsWith("http://") || s.startsWith("https://")) return s;
    const base = getBaseUrl();
    if (s.startsWith("/")) return base + s;
    return base + "/" + s;
  }

  function getToken(){ return localStorage.getItem("jwt") || ""; }
  function setToken(t){
    if (t) localStorage.setItem("jwt", t);
    else localStorage.removeItem("jwt");
    document.getElementById("tokenLabel").textContent = t ? (t.slice(0, 18) + "‚Ä¶") : "(none)";
  }

  // =========================
  // Status helper
  // =========================
  function setStatus(id, msg, type){
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.remove("ok","err","warn");
    if (type) el.classList.add(type);
    el.textContent = msg;
  }

  // =========================
  // API Fetch
  // =========================
  async function apiFetch(path, options = {}, isJsonBody = true){
    const url = getBaseUrl() + path;
    const token = getToken();

    const headers = new Headers(options.headers || {});
    if (token) headers.set("Authorization", "Bearer " + token);

    if (isJsonBody && options.body && !headers.has("Content-Type")){
      headers.set("Content-Type", "application/json");
    }

    const res = await fetch(url, { ...options, headers });

    const ct = res.headers.get("content-type") || "";
    let data = null;
    if (ct.includes("application/json")) {
      data = await res.json().catch(() => null);
    } else {
      data = await res.text().catch(() => null);
    }

    if (!res.ok){
      const msg = (data && data.error && data.error.message)
        ? data.error.message
        : (typeof data === "string" ? data : JSON.stringify(data));
      throw new Error(`HTTP ${res.status} ${res.statusText}\n${msg}`);
    }

    return data;
  }

  // =========================
  // ‚úÖ AUTH MODAL
  // =========================
  function openAuthModal(){
    document.getElementById("authModal").classList.add("open");
  }

  function closeAuthModal(event){
    if (event) event.preventDefault?.();

    // ‚úÖ If user not logged in, keep modal open
    if (!getToken()) return;

    document.getElementById("authModal").classList.remove("open");
  }

  function switchAuthTab(which){
    const loginBtn = document.getElementById("authTabLogin");
    const regBtn = document.getElementById("authTabRegister");
    const loginSec = document.getElementById("authLoginSec");
    const regSec = document.getElementById("authRegisterSec");

    if (which === "login"){
      loginBtn.classList.add("active");
      regBtn.classList.remove("active");
      loginSec.style.display = "block";
      regSec.style.display = "none";
    }else{
      regBtn.classList.add("active");
      loginBtn.classList.remove("active");
      regSec.style.display = "block";
      loginSec.style.display = "none";
    }
  }

  async function login(){
    try{
      setStatus("authStatus", "Logging in...");
      const username = document.getElementById("loginUser").value.trim();
      const password = document.getElementById("loginPass").value.trim();

      const data = await apiFetch("/api/auth/login", {
        method:"POST",
        body: JSON.stringify({ username, password })
      });

      if (!data || !data.token) throw new Error("No token returned");
      setToken(data.token);
      setStatus("authStatus", "‚úÖ Login successful", "ok");
      document.getElementById("authModal").classList.remove("open");

      // auto load
      loadPreferences();
      loadMyClothes();
      loadOutfits();
    }catch(e){
      setStatus("authStatus", "‚ùå Login failed:\n" + e.message, "err");
    }
  }

  async function register(){
    try{
      setStatus("authStatus2", "Registering...");
      const username = document.getElementById("regUser").value.trim();
      const password = document.getElementById("regPass").value.trim();
      const name = document.getElementById("regName").value.trim();
      const gender = document.getElementById("regGender").value;

      const data = await apiFetch("/api/auth/register", {
        method:"POST",
        body: JSON.stringify({ username, password, name, gender })
      });

      if (!data || !data.token) throw new Error("No token returned");
      setToken(data.token);
      setStatus("authStatus2", "‚úÖ Register successful", "ok");
      document.getElementById("authModal").classList.remove("open");

      loadPreferences();
      loadMyClothes();
      loadOutfits();
    }catch(e){
      setStatus("authStatus2", "‚ùå Register failed:\n" + e.message, "err");
    }
  }

  function logout(){
    setToken("");
    setStatus("prefStatus", "Logged out.", "warn");
    setStatus("surveyStatus", "Logged out.", "warn");
    openAuthModal();
    clearAll();
  }

  // =========================
  // ‚úÖ IMAGE LIGHTBOX
  // =========================
  function openImageModal(src, caption = ""){
    if (!src) return;
    document.getElementById("imgModalImg").src = src;
    document.getElementById("imgModalCaption").textContent = caption || "";
    document.getElementById("imgModal").classList.add("open");
  }

  function closeImageModal(event){
    if (event) event.preventDefault?.();
    document.getElementById("imgModal").classList.remove("open");
    document.getElementById("imgModalImg").src = "";
  }

  // ESC closes modals
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape"){
      if (document.getElementById("imgModal").classList.contains("open")) closeImageModal();
      if (document.getElementById("outfitModal").classList.contains("open")) closeOutfitModal();
      if (document.getElementById("authModal").classList.contains("open") && getToken()) closeAuthModal();
    }
  });

  // =========================
  // ‚úÖ Custom file input label
  // =========================
  function showSelectedFileName(){
    const fileInput = document.getElementById("clotheFile");
    const label = document.getElementById("selectedFileName");
    if (!fileInput.files || fileInput.files.length === 0){
      label.textContent = "No file selected";
      return;
    }
    label.textContent = fileInput.files[0].name;
  }

  // =========================
  // CLOTHES
  // =========================
  async function addClothe(){
    try{
      setStatus("uploadStatus", "Uploading...");
      const fileInput = document.getElementById("clotheFile");
      if (!fileInput.files || fileInput.files.length === 0){
        setStatus("uploadStatus", "Select an image file first.", "warn");
        return;
      }

      const form = new FormData();
      form.append("file", fileInput.files[0]);

      const url = getBaseUrl() + "/api/clothe/add";
      const token = getToken();
      const res = await fetch(url, {
        method:"POST",
        headers: token ? { "Authorization": "Bearer " + token } : {},
        body: form
      });

      if (!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error(`HTTP ${res.status} ${res.statusText}\n${txt}`);
      }

      setStatus("uploadStatus", "‚úÖ Uploaded!", "ok");
      fileInput.value = "";
      showSelectedFileName();
      await loadMyClothes();
    }catch(e){
      setStatus("uploadStatus", "‚ùå Upload failed:\n" + e.message, "err");
    }
  }

  async function loadMyClothes(){
    try{
      setStatus("clothesStatus", "Loading clothes...", "warn");
      document.getElementById("clothesGrid").innerHTML = "";

      const clothes = await apiFetch("/api/clothe/list", { method:"GET" });
      if (!Array.isArray(clothes)) throw new Error("Invalid clothes list");

      clothesCache = clothes;
      document.getElementById("clotheCount").textContent = clothes.length;

      const ids = clothes.map(c => c.clotheId).filter(Boolean);
      clotheImageMap.clear();

      if (ids.length > 0){
        const imgs = await apiFetch("/api/clothe/images", {
          method:"POST",
          body: JSON.stringify({ ids })
        });

        if (Array.isArray(imgs)){
          for (const it of imgs){
            if (!it || !it.id) continue;
            if (it.imageUrl){
              clotheImageMap.set(it.id, resolveUrl(it.imageUrl));
            } else if (it.base64){
              const ct = it.contentType || "image/png";
              const dataUrl = `data:${ct};base64,${it.base64}`;
              clotheImageMap.set(it.id, dataUrl);
            }
          }
        }
      }

      renderClothesGrid();
      setStatus("clothesStatus", "‚úÖ Clothes loaded.", "ok");
    }catch(e){
      setStatus("clothesStatus", "‚ùå Load clothes failed:\n" + e.message, "err");
    }
  }

  function setClothesFilter(filter, silent=false){
    currentClothesFilter = filter;

    // button UI
    document.querySelectorAll(".filterBtn").forEach(btn => {
      const f = btn.getAttribute("data-filter");
      btn.classList.toggle("active", f === filter);
    });

    if (!silent) renderClothesGrid();
  }

  function renderClothesGrid(){
    const grid = document.getElementById("clothesGrid");
    const filtered = clothesCache.filter(c => {
      if (currentClothesFilter === "all") return true;
      return String(c.category || "").toLowerCase() === currentClothesFilter;
    });

    grid.innerHTML = filtered.map(c => {
      const imgSrc = clotheImageMap.get(c.clotheId) || "";
      const seasons = (c.seasons || []).map(s => `<span class="chip">${escapeHtml(s)}</span>`).join("");
      const caption = `Clothe #${c.clotheId} ‚Äî ${(c.category||"")} ‚Ä¢ ${(c.color||"")}`;
      return `
        <div class="imgCard">
          <img
            src="${imgSrc}"
            alt="clothe-${c.clotheId}"
            onclick="openImageModal('${imgSrc}', '${escapeHtml(caption)}')"
            onerror="this.style.opacity=.25; this.title='No image';"
          />
          <div class="imgMeta">
            <div class="title">#${c.clotheId} ‚Äî ${escapeHtml(c.style || "style?")}</div>
            <div class="sub">${escapeHtml(c.category || "")} ‚Ä¢ ${escapeHtml(c.color || "")}</div>
            <div class="chips">${seasons}</div>
          </div>
        </div>
      `;
    }).join("");
  }

  // =========================
  // OUTFITS
  // =========================
  async function loadOutfits(){
    try{
      setStatus("outfitsStatus", "Loading outfits...", "warn");
      document.getElementById("outfitList").innerHTML = "";

      const outfits = await apiFetch("/api/outfit/list", { method:"GET" });
      if (!Array.isArray(outfits)) throw new Error("Invalid outfit list");

      document.getElementById("outfitCount").textContent = outfits.length;

      const list = document.getElementById("outfitList");
      list.innerHTML = outfits.map(o => {
        const ids = (o.clotheIds || []).join(", ");
        return `
          <div class="listItem">
            <div class="left">
              <div><b>Outfit #${o.id}</b></div>
              <div class="muted" style="font-size:12px; margin-top:4px">
                score: <span class="mono">${o.score}</span>
                ‚Ä¢ personal: <span class="mono">${o.personalScore}</span>
              </div>
              <div class="muted" style="font-size:12px; margin-top:4px">
                clothes: <span class="mono">${ids}</span>
              </div>
            </div>
            <div class="right">
              <button class="btnSecondary btnSmall" onclick="pickOutfitId(${o.id}); showOutfitPopup(${o.id});">Detail</button>
              <button class="btnPrimary btnSmall" onclick="pickOutfitId(${o.id}); renderOutfitOnModel();">Render</button>
            </div>
          </div>
        `;
      }).join("");

      setStatus("outfitsStatus", "‚úÖ Outfit list loaded.", "ok");
    }catch(e){
      setStatus("outfitsStatus", "‚ùå Load outfits failed:\n" + e.message, "err");
    }
  }

  function pickOutfitId(id){
    document.getElementById("outfitIdInput").value = id;
    document.getElementById("renderOutfitId").value = id;
  }

  // =========================
  // OUTFIT POPUP + STAR RATING
  // =========================
  function openOutfitModal(){
    document.getElementById("outfitModal").classList.add("open");
  }
  function closeOutfitModal(event){
    if (event) event.preventDefault?.();
    document.getElementById("outfitModal").classList.remove("open");
    document.getElementById("outfitModalStatus").textContent = "Closed.";
    document.getElementById("outfitTopGrid").innerHTML = "";
    document.getElementById("outfitBottomGrid").innerHTML = "";
    document.getElementById("outfitShoesGrid").innerHTML = "";
    lastOpenedOutfitId = null;
  }

  function buildStarsUI(defaultStars = 0){
    const box = document.getElementById("starBox");
    box.innerHTML = "";

    for (let i=1; i<=5; i++){
      const el = document.createElement("div");
      el.className = "star" + (i <= defaultStars ? " active" : "");
      el.textContent = "‚òÖ";
      el.title = `${i} / 5`;
      el.onclick = () => submitOutfitRating(i); // ‚≠ê sends 1..5
      box.appendChild(el);
    }

    const label = document.createElement("div");
    label.className = "starLabel";
    label.textContent = defaultStars ? `${defaultStars}/5` : "Rate";
    box.appendChild(label);
  }

  async function submitOutfitRating(stars){
    try{
      if (!lastOpenedOutfitId) return;

      // ‚≠ê 1..5 -> 0..1
      const personalScore = Number((stars / 5).toFixed(2)); // 0.20, 0.40 ...

      // UI highlight instantly
      buildStarsUI(stars);

      setStatus("outfitModalStatus", `Saving rating... (${stars}/5 ‚Üí ${personalScore})`, "warn");

      const path = OUTFIT_RATE_ENDPOINT_TEMPLATE(lastOpenedOutfitId);

      // ‚úÖ Backend expects: { personalScore: Double }
      const updated = await apiFetch(path, {
        method: "POST",
        body: JSON.stringify({ personalScore })
      });

      // ‚úÖ Response: { outfitId, score, personalScore }
      const msg =
        `‚úÖ Rated!\nOutfitId: ${updated.outfitId}\nScore: ${updated.score}\nPersonalScore: ${updated.personalScore}`;

      setStatus("outfitModalStatus", msg, "ok");

      // ‚úÖ Update modal meta text too
      const metaEl = document.getElementById("outfitModalMeta");
      if (metaEl && updated){
        metaEl.textContent =
          `score: ${updated.score} ‚Ä¢ personalScore: ${updated.personalScore}`;
      }

      // ‚úÖ Reload outfit list to show latest personalScore in list
      loadOutfits();

    }catch(e){
      setStatus("outfitModalStatus", "‚ùå Rating failed:\n" + e.message, "err");
    }
  }


  async function submitOutfitRating(stars){
    try{
      if (!lastOpenedOutfitId) return;

      // UI highlight instantly
      buildStarsUI(stars);

      const path = OUTFIT_RATE_ENDPOINT_TEMPLATE(lastOpenedOutfitId);

      // ‚úÖ backend expected: {stars: 1..5}
      await apiFetch(path, {
        method:"POST",
        body: JSON.stringify({ personalScore: stars / 5 })
      });

      setStatus("outfitModalStatus", `‚úÖ Rated outfit with ${stars}/5`, "ok");

      // Optional: reload outfits list to reflect new score/personalScore
      loadOutfits();
    }catch(e){
      setStatus("outfitModalStatus", "‚ùå Rating failed:\n" + e.message, "err");
    }
  }

  async function rateOutfit(outfitId, stars) {
  try {
    // ‚≠ê 1-5 -> 0-1
    const personalScore = Number((stars / 5).toFixed(2)); // 0.20 ... 1.00

    const data = await apiFetch(`/api/outfit/${outfitId}/rate`, {
      method: "POST",
      body: JSON.stringify({ personalScore })
    });

    setStatus(
      "outfitModalStatus",
      `‚úÖ Rated Outfit #${data.outfitId}\nscore: ${Number(data.score).toFixed(2)}\npersonalScore: ${Number(data.personalScore).toFixed(2)}`,
      "ok"
    );

    // optional: refresh outfits list after rating
    // loadOutfits();

  } catch (e) {
    setStatus("outfitModalStatus", "‚ùå Rating failed:\n" + e.message, "err");
  }
}


  async function showOutfitPopup(outfitId){
    try{
      if (!outfitId) return;
      outfitId = String(outfitId).trim();
      lastOpenedOutfitId = outfitId;

      document.getElementById("outfitModalTitle").textContent = `Outfit #${outfitId} Detail`;
      document.getElementById("outfitModalMeta").textContent = "";
      setStatus("outfitModalStatus", "Loading outfit detail...", "warn");

      document.getElementById("outfitTopGrid").innerHTML = "";
      document.getElementById("outfitBottomGrid").innerHTML = "";
      document.getElementById("outfitShoesGrid").innerHTML = "";

      // default stars UI
      buildStarsUI(0);

      openOutfitModal();

      const data = await apiFetch(`/api/outfit/${outfitId}`, { method:"GET" });
      if (!data || !Array.isArray(data.clothes)) throw new Error("Outfit detail response invalid");

      document.getElementById("outfitModalMeta").textContent =
        `score: ${data.score} ‚Ä¢ personalScore: ${data.personalScore} ‚Ä¢ clothes: ${data.clothes.length}`;

      // categorization
      const topOrOne = [];
      const bottom = [];
      const shoes = [];

      for (const c of data.clothes){
        const cat = String(c.category || "").toLowerCase();

        if (cat === "shoes") shoes.push(c);
        else if (cat === "bottom") bottom.push(c);
        else topOrOne.push(c); // top or one_piece or others
      }

      // Render category grids
      document.getElementById("outfitTopGrid").innerHTML = topOrOne.map(renderOutfitClotheCard).join("");
      document.getElementById("outfitBottomGrid").innerHTML = bottom.map(renderOutfitClotheCard).join("");
      document.getElementById("outfitShoesGrid").innerHTML = shoes.map(renderOutfitClotheCard).join("");

      // If backend returns a saved rating field (optional), you can prefill stars:
      // buildStarsUI(data.userRating ?? 0);

      setStatus("outfitModalStatus", "‚úÖ Outfit detail loaded. Click images to zoom.", "ok");
    }catch(e){
      setStatus("outfitModalStatus", "‚ùå Outfit detail failed:\n" + e.message, "err");
    }
  }

  function renderOutfitClotheCard(c){
    const imgSrc = c.imageUrl
      ? resolveUrl(c.imageUrl)
      : (c.imageBase64 ? `data:${c.imageContentType || "image/png"};base64,${c.imageBase64}` : "");

    const caption = `Clothe #${c.clotheId} ‚Äî ${(c.category||"")} ‚Ä¢ ${(c.color||"")}`;

    return `
      <div class="imgCard">
        <img
          src="${imgSrc}"
          alt="clothe-${c.clotheId}"
          onclick="openImageModal('${imgSrc}', '${escapeHtml(caption)}')"
          onerror="this.style.opacity=.25; this.title='No image';"
        />
        <div class="imgMeta">
          <div class="title">#${c.clotheId} ‚Äî ${escapeHtml(c.style || "")}</div>
          <div class="sub">${escapeHtml(c.category || "")} ‚Ä¢ ${escapeHtml(c.color || "")}</div>
        </div>
      </div>
    `;
  }

  async function renderFromModal(){
    if (!lastOpenedOutfitId) return;
    document.getElementById("renderOutfitId").value = lastOpenedOutfitId;
    await renderOutfitOnModel(true);
  }

  // =========================
  // RECOMMEND (CHAT ONLY)
  // =========================
  async function recommendByChat(){
    try{
      const text = document.getElementById("chatInput").value.trim();
      if (!text){
        setStatus("recommendStatus", "Enter chat text first.", "warn");
        return;
      }

      setStatus("recommendStatus", "Recommending by chat...", "warn");
      const data = await apiFetch("/api/recommend/by-chat", {
        method:"POST",
        body: JSON.stringify({ text })
      });

      renderRecommendList(data);
      setStatus("recommendStatus", "‚úÖ Chat recommendation ready.", "ok");
    }catch(e){
      setStatus("recommendStatus", "‚ùå Chat recommend failed:\n" + e.message, "err");
    }
  }

  function renderRecommendList(data){
    const box = document.getElementById("recommendList");
    if (!data){ box.innerHTML = ""; return; }

    // RecommendByOpenAiResponse = { message, selectedOutfitIds, outfits:[...] }
    if (data.outfits){
      box.innerHTML = `
        <div class="listItem">
          <div class="left">
            <div><b>Chat Recommend</b></div>
            <div class="muted" style="margin-top:6px">${escapeHtml(data.message || "")}</div>
            <div class="muted" style="margin-top:6px">selected: <span class="mono">${(data.selectedOutfitIds || []).join(", ")}</span></div>
          </div>
        </div>
      ` + data.outfits.map(o => `
        <div class="listItem">
          <div class="left">
            <div><b>Outfit #${o.outfitId}</b> <span class="muted">(score: <span class="mono">${o.score}</span>)</span></div>
            <div class="muted" style="margin-top:6px">clothes: ${(o.clothes || []).map(c => `#${c.clotheId}`).join(", ")}</div>
          </div>
          <div class="right">
            <button class="btnSecondary btnSmall" onclick="pickOutfitId(${o.outfitId}); showOutfitPopup(${o.outfitId});">Detail</button>
            <button class="btnPrimary btnSmall" onclick="pickOutfitId(${o.outfitId}); renderOutfitOnModel();">Render</button>
          </div>
        </div>
      `).join("");
      return;
    }

    box.innerHTML = `<pre class="status">${escapeHtml(JSON.stringify(data, null, 2))}</pre>`;
  }

  // =========================
  // ‚úÖ Weather to Prompt (Geolocation -> Open-Meteo)
  // =========================
  async function appendWeatherToChat(){
    try{
      setStatus("recommendStatus", "Getting weather from your location...", "warn");

      const pos = await new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error("Geolocation not supported"));
        navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy:true, timeout: 10000 });
      });

      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      // ‚úÖ Open-Meteo current weather (no api key)
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("Weather API failed");

      const json = await res.json();
      const cw = json.current_weather;
      if (!cw) throw new Error("No current_weather in response");

      const temp = cw.temperature;
      const wind = cw.windspeed;
      const code = cw.weathercode;

      const weatherText =
        ` Weather info: temperature ${temp}¬∞C, wind ${wind} km/h, code ${code}.`;

      const chat = document.getElementById("chatInput");
      chat.value = (chat.value || "").trim() + weatherText;

      setStatus("recommendStatus", "‚úÖ Weather added to prompt.", "ok");
    }catch(e){
      setStatus("recommendStatus", "‚ùå Weather failed:\n" + e.message, "err");
    }
  }

  // =========================
  // RENDER ON MODEL (AI)
  // =========================
  async function renderOutfitOnModel(useRenderTab=false){
    try{
      const inputId = useRenderTab ? "renderOutfitId" : "outfitIdInput";
      const outfitId = document.getElementById(inputId).value.trim();

      if (!outfitId){
        setStatus("renderStatus", "Enter outfit ID first.", "warn");
        return;
      }

      // Switch to render tab if requested
      if (useRenderTab){
        document.querySelector('[data-tab="renderSec"]').click();
      }

      setStatus("renderStatus", "Rendering on model (AI)...", "warn");
      document.getElementById("renderGrid").innerHTML = "";

      // 1) POST /api/outfits/{id}/render -> { imageUrl: "id" }
      const renderResp = await apiFetch(`/api/outfits/${outfitId}/render`, { method:"POST" });
      if (!renderResp || !renderResp.imageUrl) throw new Error("Render response did not contain imageUrl");

      const imageId = String(renderResp.imageUrl).trim();

      // 2) GET /api/generated-images/{id} -> image bytes
      const imageFetchUrl = getBaseUrl() + "/api/generated-images/" + imageId;
      const token = getToken();

      const imgRes = await fetch(imageFetchUrl, {
        method:"GET",
        headers: token ? { "Authorization": "Bearer " + token } : {}
      });

      if (!imgRes.ok){
        const txt = await imgRes.text().catch(()=> "");
        throw new Error(`GET image failed: HTTP ${imgRes.status}\n${txt}`);
      }

      const blob = await imgRes.blob();

      // cleanup old object URL
      if (lastRenderObjectUrl) URL.revokeObjectURL(lastRenderObjectUrl);
      lastRenderObjectUrl = URL.createObjectURL(blob);

      document.getElementById("renderGrid").innerHTML = `
        <div class="imgCard">
          <img
            src="${lastRenderObjectUrl}"
            alt="rendered-outfit"
            onclick="openImageModal('${lastRenderObjectUrl}', 'Rendered Outfit for #${outfitId}')"
          />
          <div class="imgMeta">
            <div class="title">Rendered Outfit for #${outfitId}</div>
            <div class="sub">
              imageId: <span class="mono">${escapeHtml(imageId)}</span><br/>
              fetch: <span class="mono">${escapeHtml(imageFetchUrl)}</span>
            </div>
          </div>
        </div>
      `;

      setStatus("renderStatus", "‚úÖ Render complete.", "ok");
    }catch(e){
      setStatus("renderStatus", "‚ùå Render failed:\n" + e.message, "err");
    }
  }

  // =========================
  // ‚úÖ Preferences (Load + Survey Save)
  // =========================
  function buildSurveyPickers(){
    const colorsBox = document.getElementById("colorsBox");
    const stylesBox = document.getElementById("stylesBox");

    colorsBox.innerHTML = ALLOWED_COLORS.map(c => `
      <span class="chip" style="cursor:pointer" onclick="toggleChip(this, 'colors')">${escapeHtml(c)}</span>
    `).join("");

    stylesBox.innerHTML = ALLOWED_STYLES.map(s => `
      <span class="chip" style="cursor:pointer" onclick="toggleChip(this, 'styles')">${escapeHtml(s)}</span>
    `).join("");
  }

  function toggleChip(el, type){
    el.style.background = el.dataset.on === "1"
      ? "rgba(109,40,217,.06)"
      : "linear-gradient(90deg, rgba(109,40,217,.16), rgba(219,39,119,.12))";
    el.dataset.on = (el.dataset.on === "1") ? "0" : "1";
  }

  function getSelectedChips(type){
    const box = (type === "colors") ? document.getElementById("colorsBox") : document.getElementById("stylesBox");
    const chips = Array.from(box.querySelectorAll(".chip"));
    return chips.filter(x => x.dataset.on === "1").map(x => x.textContent.trim());
  }

  function resetSurvey(){
    document.querySelectorAll("#colorsBox .chip, #stylesBox .chip").forEach(c => {
      c.dataset.on = "0";
      c.style.background = "rgba(109,40,217,.06)";
    });
    document.getElementById("outfitPreferenceSelect").value = "EQUAL";
    setStatus("surveyStatus", "Survey reset.", "warn");
  }

  async function saveSurvey(){
    try{
      const favoriteColors = getSelectedChips("colors");
      const favoriteStyles = getSelectedChips("styles");
      const outfitPreference = document.getElementById("outfitPreferenceSelect").value;

      setStatus("surveyStatus", "Saving survey...", "warn");

      // Backend expects SaveSurveyRequest(userId, favoriteColors, favoriteStyles, outfitPreference)
      // If backend extracts userId from token, you can omit it.
      const payload = {
        userId: null,
        favoriteColors,
        favoriteStyles,
        outfitPreference
      };

      const data = await apiFetch("/api/preferences/survey", {
        method:"POST",
        body: JSON.stringify(payload)
      });

      setStatus("surveyStatus", "‚úÖ Survey saved:\n" + JSON.stringify(data, null, 2), "ok");
    }catch(e){
      setStatus("surveyStatus", "‚ùå Survey save failed:\n" + e.message, "err");
    }
  }

  async function loadPreferences(){
    try{
      setStatus("prefStatus", "Loading preferences...", "warn");

      // ‚úÖ If you add this endpoint later, it will work:
      // try /api/preferences/me then fallback /api/preferences
      let data = null;
      try{
        data = await apiFetch("/api/preferences/me", { method:"GET" });
      }catch(_){
        data = await apiFetch("/api/preferences", { method:"GET" });
      }

      setStatus("prefStatus", "‚úÖ Preferences loaded:\n" + JSON.stringify(data, null, 2), "ok");
    }catch(e){
      setStatus("prefStatus", "‚ùå Load preferences failed:\n" + e.message, "err");
    }
  }

  // =========================
  // UTIL
  // =========================
  function clearAll(){
    document.getElementById("clothesGrid").innerHTML = "";
    document.getElementById("outfitList").innerHTML = "";
    document.getElementById("recommendList").innerHTML = "";
    document.getElementById("renderGrid").innerHTML = "";

    setStatus("clothesStatus", "Cleared.", "warn");
    setStatus("outfitsStatus", "Cleared.", "warn");
    setStatus("recommendStatus", "Cleared.", "warn");
    setStatus("renderStatus", "Cleared.", "warn");

    document.getElementById("clotheCount").textContent = "0";
    document.getElementById("outfitCount").textContent = "0";

    clothesCache = [];
    clotheImageMap.clear();
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // =========================
  // INIT
  // =========================
  function init(){
    syncBaseLabel();
    setToken(getToken());
    buildSurveyPickers();
    resetSurvey();

    if (!getToken()){
      openAuthModal();
    }else{
      // logged in -> load initial data
      loadPreferences();
      loadMyClothes();
      loadOutfits();
    }
  }
  init();
</script>

</body>
</html>
